name: Build & Deploy RayService

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build-and-deploy:
    name: Build image and deploy RayService
    runs-on: ubuntu-latest
    env:
      # Defaults (can be overridden by workflow inputs or secrets)
      IMAGE_NAME: ${{ env.IMAGE_NAME || 'team/my-ray-serve' }}
      SEARCH_IMAGE: "myregistry.example.com/team/my-ray-serve:2.54.0"
      RAYSERVICE_MANIFEST: "manifests/rayservice.yaml"
      RAYSERVICE_NAME: "my-serve-app"
      NAMESPACE: "default"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Prepare env vars
        id: vars
        run: |
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          IMAGE_TAG=${{ secrets.IMAGE_TAG || SHORT_SHA }}
          IMAGE_FULL="${{ secrets.DOCKER_REGISTRY }}/$IMAGE_NAME:${IMAGE_TAG}"
          echo "IMAGE_FULL=${IMAGE_FULL}" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Make build script executable
        run: |
          chmod +x deploy/build-and-deploy.sh

      - name: Run build-and-deploy
        env:
          DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
          IMAGE_FULL: ${{ steps.vars.outputs.IMAGE_FULL }}
          IMAGE_TAG: ${{ steps.vars.outputs.IMAGE_TAG }}
          SEARCH_IMAGE: ${{ env.SEARCH_IMAGE }}
          RAYSERVICE_MANIFEST: ${{ env.RAYSERVICE_MANIFEST }}
          RAYSERVICE_NAME: ${{ env.RAYSERVICE_NAME }}
          NAMESPACE: ${{ env.NAMESPACE }}
        run: |
          ./deploy/build-and-deploy.sh